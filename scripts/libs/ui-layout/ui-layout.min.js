"use strict";angular.module("ui.layout",[]).controller("uiLayoutCtrl",["$scope","$attrs","$element","$timeout","$window","LayoutContainer",function(e,i,n,t,s,r){function a(){var i=p.sizeProperties.flowProperty,s=parseInt(d.dividerSize),r=n[0][p.sizeProperties.offsetSize];if(null!==p.movingSplitbar){var a=p.containers.indexOf(p.movingSplitbar),o=a+2<p.containers.length?a+2:null;if(a>-1){var l=p.processSplitbar(p.containers[a]),f=l.beforeContainer,m=l.afterContainer;if(!f.collapsed&&!m.collapsed){var g=p.movingSplitbar[i]-c,y=p.movingSplitbar[i]-g;y=Math.min(r-s,y),angular.isNumber(f.beforeMinValue)&&y<f.beforeMinValue&&(y=f.beforeMinValue),angular.isNumber(f.beforeMaxValue)&&y>f.beforeMaxValue&&(y=f.beforeMaxValue),null!==m&&angular.isNumber(m.afterMinValue)&&y>m.afterMinValue-s&&(y=m.afterMinValue-s),null!==m&&angular.isNumber(m.afterMaxValue)&&y<m.afterMaxValue&&(y=m.afterMaxValue),f.size=y-f[i];var S=m[i];m[i]=y+s,m[i]!=S&&(m.size=null!==o?S+m.size-(y+s):r-(y+s)),p.movingSplitbar[i]=y,z&&t.cancel(z),z=t(function(){e.$broadcast("ui.layout.resize",f,m),z=null},50)}}}u=null}function o(e){var i=e[0],n=document.documentElement||document.body,t=window.pageXOffset||n.scrollLeft,s=window.pageYOffset||n.scrollTop,r=i.getBoundingClientRect(),a=r.left+t,o=r.top+s;return{left:a,top:o}}function l(e){return"number"==typeof e||"string"==typeof e&&e.match(m)?e:null}var u,c,p=this,d=angular.extend({},e.$eval(i.uiLayout),e.$eval(i.options)),f=0,m=/\d+\s*(px|%)\s*$/i;p.containers=[],p.movingSplitbar=null,p.bounds=n[0].getBoundingClientRect(),p.isUsingColumnFlow="column"===d.flow,p.sizeProperties=p.isUsingColumnFlow?{sizeProperty:"width",offsetSize:"offsetWidth",offsetPos:"left",flowProperty:"left",oppositeFlowProperty:"right",mouseProperty:"clientX",flowPropertyPosition:"x"}:{sizeProperty:"height",offsetSize:"offsetHeight",offsetPos:"top",flowProperty:"top",oppositeFlowProperty:"bottom",mouseProperty:"clientY",flowPropertyPosition:"y"},n.addClass("stretch").addClass("ui-layout-"+(d.flow||"row")),d.disableToggle&&n.addClass("no-toggle"),d.disableMobileToggle&&n.addClass("no-mobile-toggle"),d.sizes=d.sizes||[],d.maxSizes=d.maxSizes||[],d.minSizes=d.minSizes||[],d.dividerSize=d.dividerSize||10,d.collapsed=d.collapsed||[],p.opts=d,e.updateDisplay=function(){p.updateDisplay()};var z;return p.mouseUpHandler=function(e){return null!==p.movingSplitbar&&(p.movingSplitbar=null),e},p.mouseMoveHandler=function(e){var i=e[p.sizeProperties.mouseProperty]||e.originalEvent&&e.originalEvent[p.sizeProperties.mouseProperty]||(s.jQuery?e.originalEvent?e.originalEvent.targetTouches[0][p.sizeProperties.mouseProperty]:0:e.targetTouches?e.targetTouches[0][p.sizeProperties.mouseProperty]:0);c=i-o(n)[p.sizeProperties.offsetPos],u&&window.cancelAnimationFrame(u),u=window.requestAnimationFrame(a)},p.processSplitbar=function(e){var i=p.containers.indexOf(e),n=function(e){var i=e[p.sizeProperties.flowProperty],n=e[p.sizeProperties.flowProperty]+e.size;e.beforeMinValue=angular.isNumber(e.minSize)?i+e.minSize:i,e.beforeMaxValue=angular.isNumber(e.maxSize)?i+e.maxSize:null,e.afterMinValue=angular.isNumber(e.minSize)?n-e.minSize:n,e.afterMaxValue=angular.isNumber(e.maxSize)?n-e.maxSize:null};if(i>-1){var t=i>0?p.containers[i-1]:null,s=i+1<=p.containers.length?p.containers[i+1]:null;return null!==t&&n(t),null!==s&&n(s),{beforeContainer:t,afterContainer:s}}return null},p.isPercent=function(e){return e&&angular.isString(e)&&e.indexOf("%")>-1?!0:!1},p.convertToPixels=function(e,i){return Math.floor(i*(parseInt(e)/100))},p.updateDisplay=function(){var e,i,t=parseInt(d.dividerSize),s=n[0].getBoundingClientRect()[p.sizeProperties.sizeProperty],a=s-t*f,o=a,u=0,c=0;if(p.containers.length>0&&n.children().length>0){for(i=0;i<p.containers.length;i++)if(!r.isSplitbar(p.containers[i])){var m=p.containers[i].element;d.maxSizes[i]=m.attr("max-size")||m.attr("data-max-size")||d.maxSizes[i]||null,d.minSizes[i]=m.attr("min-size")||m.attr("data-min-size")||d.minSizes[i]||null,d.sizes[i]=m.attr("size")||m.attr("data-size")||d.sizes[i]||"auto",d.sizes[i]=l(d.sizes[i])||"auto",d.minSizes[i]=l(d.minSizes[i]),d.maxSizes[i]=l(d.maxSizes[i]),"auto"!=d.sizes[i]&&(p.isPercent(d.sizes[i])?d.sizes[i]=p.convertToPixels(d.sizes[i],o):d.sizes[i]=parseInt(d.sizes[i])),null!=d.minSizes[i]&&(p.isPercent(d.minSizes[i])?d.minSizes[i]=p.convertToPixels(d.minSizes[i],o):d.minSizes[i]=parseInt(d.minSizes[i]),d.sizes[i]<d.minSizes[i]&&(d.sizes[i]=d.minSizes[i])),null!=d.maxSizes[i]&&(p.isPercent(d.maxSizes[i])?d.maxSizes[i]=p.convertToPixels(d.maxSizes[i],o):d.maxSizes[i]=parseInt(d.maxSizes[i]),d.sizes[i]>d.maxSizes[i]&&(d.sizes[i]=d.maxSizes[i])),"auto"===d.sizes[i]?c++:a-=d.sizes[i]}var z=Math.floor(a/c);for(i=0;i<p.containers.length;i++){if(e=p.containers[i],e[p.sizeProperties.flowProperty]=u,e.maxSize=d.maxSizes[i],e.minSize=d.minSizes[i],e.collapsed=e.collapsed||d.collapsed[i],r.isSplitbar(e))e.size=t;else{var g="auto"===d.sizes[i]?z:d.sizes[i];e.size=null!==g?g:z}u+=e.size}}},p.addContainer=function(e){var i=p.indexOfElement(e.element);return!angular.isDefined(i)||0>i||p.containers.length<i?void console.error("Invalid index to add container; i="+i+", len=",p.containers.length):(r.isSplitbar(e)&&f++,p.containers.splice(i,0,e),void p.updateDisplay())},p.removeContainer=function(e){var i=p.containers.indexOf(e);if(i>=0){r.isSplitbar(e)?(p.containers[i-1].collapsed=!1,f--):p.containers.length>2&&(i==p.containers.length-1?p.containers[i-1].element.remove():p.containers[i+1].element.remove());var n=p.containers.indexOf(e);n>=0&&p.containers.splice(n,1),p.updateDisplay()}else console.error("removeContainer for container that did not exist!")},p.getContainers=function(){return p.containers},p.toggleBefore=function(i){var n=p.containers.indexOf(i)-1,t=p.containers[n];t.collapsed=!p.containers[n].collapsed;var s=p.containers[n+1],r=p.containers[n+2];return e.$apply(function(){t.collapsed?(t.actualSize=t.size,t.size=0,s&&(s[p.sizeProperties.flowProperty]-=t.actualSize),r&&(r[p.sizeProperties.flowProperty]-=t.actualSize,r.size+=t.actualSize)):(t.size=t.actualSize,s&&(s[p.sizeProperties.flowProperty]+=t.actualSize),r&&(r[p.sizeProperties.flowProperty]+=t.actualSize,r.size-=t.actualSize))}),e.$broadcast("ui.layout.toggle",t),t.collapsed},p.toggleAfter=function(i){var t,s=p.containers.indexOf(i)+1,r=p.containers[s],a=p.containers[s-1],o=p.containers[s-2],l=s===p.containers.length-1;return p.bounds=n[0].getBoundingClientRect(),r.collapsed=!p.containers[s].collapsed,e.$apply(function(){r.collapsed?(r.actualSize=r.size,r.size=0,t=l?p.bounds[p.sizeProperties.sizeProperty]-r[p.sizeProperties.flowProperty]-r.actualSize:0,a&&(a[p.sizeProperties.flowProperty]+=r.actualSize+t),o&&(o.size+=r.actualSize+t)):(r.size=r.actualSize,t=l?p.bounds[p.sizeProperties.sizeProperty]-r[p.sizeProperties.flowProperty]-r.actualSize:0,a&&(a[p.sizeProperties.flowProperty]-=r.actualSize+t),o&&(o.size-=r.actualSize+t))}),e.$broadcast("ui.layout.toggle",r),r.collapsed},p.getPreviousSplitbarContainer=function(e){if(r.isSplitbar(e)){var i=p.containers.indexOf(e),n=i-2;return n>=0?p.containers[n]:null}return null},p.getNextSplitbarContainer=function(e){if(r.isSplitbar(e)){var i=p.containers.indexOf(e),n=i+2;return i>0&&n<p.containers.length?p.containers[n]:null}return null},p.hasSplitbarBefore=function(e){var i=p.containers.indexOf(e);return i>=1?r.isSplitbar(p.containers[i-1]):!1},p.hasSplitbarAfter=function(e){var i=p.containers.indexOf(e);return i<p.containers.length-1?r.isSplitbar(p.containers[i+1]):!1},p.isLayoutElement=function(e){return e.hasAttribute("ui-layout-container")||e.hasAttribute("ui-splitbar")||"UI-LAYOUT-CONTAINER"===e.nodeName},p.indexOfElement=function(e){for(var i=e.parent(),n=i.children(),t=0,s=0;s<n.length;s++){var r=n[s];if(p.isLayoutElement(r)){if(e[0]==n[s])return t;t++}}return-1},p}]).directive("uiLayout",["$window",function(e){return{restrict:"AE",controller:"uiLayoutCtrl",link:function(i,n,t,s){function r(){i.$evalAsync(function(){s.updateDisplay()})}i.$watch(function(){return n[0][s.sizeProperties.offsetSize]},function(){s.updateDisplay()}),angular.element(e).bind("resize",r),i.$on("$destroy",function(){angular.element(e).unbind("resize",r)})}}}]).directive("uiSplitbar",["LayoutContainer",function(e){var i=angular.element(document.body.parentElement);return{restrict:"EAC",require:"^uiLayout",scope:{},link:function(n,t,s,r){t.hasClass("stretch")||t.addClass("stretch"),t.hasClass("ui-splitbar")||t.addClass("ui-splitbar"),n.splitbar=e.Splitbar(),n.splitbar.element=t;var a=angular.element(t.children()[0]),o=angular.element(t.children()[1]),l=angular.element(a.children()[0]),u=angular.element(o.children()[0]),c="ui-splitbar-icon-left",p="ui-splitbar-icon-right",d="ui-splitbar-icon-up",f="ui-splitbar-icon-down",m=r.isUsingColumnFlow?c:d,z=r.isUsingColumnFlow?p:f;l.addClass(m),u.addClass(z),a.on("click",function(){var e,i,t=r.toggleBefore(n.splitbar),s=r.getPreviousSplitbarContainer(n.splitbar);null!==s&&(e=angular.element(s.element.children()[0]),i=angular.element(s.element.children()[1])),r.isUsingColumnFlow?t?(o.css("display","none"),l.removeClass(c),l.addClass(p),null!==s&&(e.css("display","none"),i.css("display","none"))):(o.css("display","inline"),l.removeClass(p),l.addClass(c),null!==s&&(e.css("display","inline"),i.css("display","inline"))):t?(o.css("display","none"),l.removeClass(d),l.addClass(f),null!==s&&(e.css("display","none"),i.css("display","none"))):(o.css("display","inline"),l.removeClass(f),l.addClass(d),null!==s&&(e.css("display","inline"),i.css("display","inline")))}),o.on("click",function(){var e,i,t=r.toggleAfter(n.splitbar),s=r.getNextSplitbarContainer(n.splitbar);null!==s&&(e=angular.element(s.element.children()[0]),i=angular.element(s.element.children()[1])),r.isUsingColumnFlow?t?(a.css("display","none"),u.removeClass(p),u.addClass(c),null!==s&&(e.css("display","none"),i.css("display","none"))):(a.css("display","inline"),u.removeClass(c),u.addClass(p),null!==s&&(e.css("display","inline"),i.css("display","inline"))):t?(a.css("display","none"),u.removeClass(f),u.addClass(d),null!==s&&(e.css("display","none"),i.css("display","none"))):(a.css("display","inline"),u.removeClass(d),u.addClass(f),null!==s&&(e.css("display","inline"),i.css("display","inline")))}),t.on("mousedown touchstart",function(e){return r.movingSplitbar=n.splitbar,r.processSplitbar(n.splitbar),e.preventDefault(),e.stopPropagation(),i.on("mousemove touchmove",function(e){n.$apply(angular.bind(r,r.mouseMoveHandler,e))}),!1}),i.on("mouseup touchend",function(e){n.$apply(angular.bind(r,r.mouseUpHandler,e)),i.off("mousemove touchmove")}),n.$watch("splitbar.size",function(e){t.css(r.sizeProperties.sizeProperty,e+"px")}),n.$watch("splitbar."+r.sizeProperties.flowProperty,function(e){t.css(r.sizeProperties.flowProperty,e+"px")}),n.$on("$destroy",function(){i.off("mouseup touchend mousemove touchmove")}),r.addContainer(n.splitbar),t.on("$destroy",function(){r.removeContainer(n.splitbar),n.$evalAsync()})}}}]).directive("uiLayoutContainer",["LayoutContainer","$compile",function(e,i){return{restrict:"AE",require:"^uiLayout",scope:{},compile:function(){return{pre:function(i,n,t,s){i.container=e.Container(),i.container.element=n,s.addContainer(i.container),n.on("$destroy",function(){s.removeContainer(i.container),i.$evalAsync()})},post:function(e,n,t,s){n.hasClass("stretch")||n.addClass("stretch"),n.hasClass("ui-layout-container")||n.addClass("ui-layout-container"),e.$watch("container.size",function(e){n.css(s.sizeProperties.sizeProperty,e+"px")}),e.$watch("container."+s.sizeProperties.flowProperty,function(e){n.css(s.sizeProperties.flowProperty,e+"px")});var r=n.parent(),a=r.children(),o=s.indexOfElement(n),l=angular.element('<div ui-splitbar><a><span class="ui-splitbar-icon"></span></a><a><span class="ui-splitbar-icon"></span></a></div>');o>0&&!s.hasSplitbarBefore(e.container)?(angular.element(a[o-1]).after(l),i(l)(e)):o<a.length-1&&(n.after(l),i(l)(e))}}}}}]).factory("LayoutContainer",function(){function e(){this.size=0,this.maxSize=null,this.minSize=0,this.resizable=!0,this.locked=!1,this.element=null,this.collapsed=!1}function i(){this.size=10,this.left=0,this.top=0,this.element=null}return{Container:function(i){return new e(i)},Splitbar:function(){return new i},isSplitbar:function(e){return e instanceof i}}});