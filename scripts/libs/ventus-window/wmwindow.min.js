"use strict";angular.module("ngWindowManager",[]).directive("wmwindow",["$timeout",function(a){return{template:'<div class="wmWindow"><div class="wmWindowOverlay"></div><div class="wmWindowBox"><div class="wmTitleBar"><div class="wmTitle">{{title}}</div><div class="wmButtonBar"><button class="wmMinimize" ng-show="!!minimizable && state !== 1"><button class="wmRestore" ng-show="state !== 0"><button class="wmMaximize" ng-show="!!maximizable && state !== 2"><button class="wmClose" ng-show="!!closable"/></div></div><div class="wmContent" ng-transclude></div><button class="wmResize" ng-show="state === 0"/></div></div>',restrict:"E",replace:true,transclude:true,scope:{title:"@",options:"@",onOpen:"&",onSelect:"&",onResizing:"&",onMinimized:"&",onMaximized:"&",onRestored:"&",onClosed:"&"},link:function(c,e){var F=e[0].parentElement;var z=e[0].children[0];var y=angular.element(e[0].children[1]);var f=y[0].children[0];var l=f.children[1];var w=y[0].children[1];var q=y[0].children[2];var E=l.children[0];var o=l.children[1];var v=l.children[2];var d=l.children[3];var G=null;var h=null;var s=null;var j={};j.elem=e;var g=c.options?JSON.parse(c.options):{};var r=g.container===undefined?F:document.getElementById(g.container);var C;if(g.viewport!=="window"){var B=document.getElementById(g.viewport)||document.getElementsByTagName(g.viewport);C=g.viewport?B:r}else{C=window}F.topZ=F.topZ||g.initialZIndex||angular.element(F).css("z-index")||99;if(F.topZ==="auto"){F.topZ=99}c.maximizable=!!g.maximizable;c.minimizable=!!g.minimizable;c.closable=!!g.closable;c.state=0;c.modal=!!g.modal;var t=function(J){var I=parseInt(y.prop("offsetLeft"),10);var H=parseInt(y.prop("offsetTop"),10);return{x:J.x-I,y:J.y-H}};var D=function(J){var I=parseInt(y.prop("offsetWidth"),10);var H=parseInt(y.prop("offsetHeight"),10);return{width:I-J.width,height:H-J.height}};var n=function(I){var H=(I.targetTouches&&I.targetTouches.length===1)?I.targetTouches[0]:I;if(G){j.move(H.pageX-G.x,H.pageY-G.y)}I.preventDefault()};var k=function(I){var H=(I.targetTouches&&I.targetTouches.length===1);if(G){e.removeClass("moving");G=null}r.removeEventListener(H?"touchmove":"mousemove",n);r.removeEventListener(H?"touchend":"mouseup",k);f.removeEventListener("click",j.selectWindow);I.preventDefault()};var x=function(I){var H=(I.targetTouches&&I.targetTouches.length===1)?I.targetTouches[0]:I;if(h){j.resize(H.pageX+h.width,H.pageY+h.height)}I.preventDefault()};var A=function(I){var H=(I.targetTouches&&I.targetTouches.length===1);if(h){e.removeClass("resizing");h=null}r.removeEventListener(H?"touchmove":"mousemove",x);r.removeEventListener(H?"touchend":"mouseup",A);I.preventDefault()};var i=function(J){var I=(J.targetTouches&&J.targetTouches.length===1);var H=I?J.targetTouches[0]:J;G=t({x:H.pageX,y:H.pageY});e.addClass("moving");r.addEventListener(I?"touchmove":"mousemove",n);r.addEventListener(I?"touchend":"mouseup",k);j.selectWindow();J.preventDefault()};var m=function(J){var I=(J.targetTouches&&J.targetTouches.length===1);var H=I?J.targetTouches[0]:J;h=D({width:H.pageX,height:H.pageY});e.addClass("resizing");r.addEventListener(I?"touchmove":"mousemove",x);r.addEventListener(I?"touchend":"mouseup",A);j.selectWindow();J.preventDefault()};var p=function(){f.addEventListener("mousedown",i);f.addEventListener("touchstart",i);w.addEventListener("click",j.selectWindow)};var u=function(){f.removeEventListener("mousedown",i);f.removeEventListener("touchstart",i);w.removeEventListener("click",j.selectWindow)};j.move=function(H,I){if(H){y.css("left",H+"px")}if(I){y.css("top",I+"px")}};j.resize=function(I,H){if(I){y.css("width",I+"px")}if(H){y.css("height",H+"px")}c.onResizing({$dlg:j})};j.selectWindow=function(){F.topZ+=1;e.css("z-index",F.topZ);c.onSelect({$dlg:j})};j.minimize=function(){if(c.state===0){s={x:parseInt(y.prop("offsetLeft"),10),y:parseInt(y.prop("offsetTop"),10),width:parseInt(y.prop("offsetWidth"),10),height:parseInt(y.prop("offsetHeight"),10),z:e.css("z-index")}}var H={x:parseInt(C.offsetWidth||0,10),y:parseInt(C.offsetHeight||0,10),width:200,height:40};e.removeClass("maximized");j.move(H.x-200,H.y-40);e.addClass("minimizing");j.resize(H.width,H.height);u();c.state=1;a(function(){if(c.modal){e.removeClass("modal")}e.removeClass("minimizing");e.removeClass("minimizing");e.addClass("minimized")},500);c.onMinimized({$dlg:j})};j.maximize=function(){if(c.state===0){s={x:parseInt(y.prop("offsetLeft"),10),y:parseInt(y.prop("offsetTop"),10),width:parseInt(y.prop("offsetWidth"),10),height:parseInt(y.prop("offsetHeight"),10),z:e.css("z-index")}}var H={x:parseInt(C.offsetLeft||0,10),y:parseInt(C.offsetTop||0,10),width:parseInt(C.offsetWidth||C.innerWidth,10),height:parseInt(C.offsetHeight||C.innerHeight,10)};e.removeClass("minimized");j.move(H.x+10,H.y+10);e.addClass("maximizing");j.resize(H.width-20,H.height-20);u();c.state=2;a(function(){e.removeClass("maximizing");e.addClass("maximized");if(c.modal){e.addClass("modal")}},500);c.onMaximized({$dlg:j})};j.restore=function(){e.removeClass("maximized");e.removeClass("minimized");e.addClass("restoring");j.move(s.x,s.y);j.resize(s.width,s.height);e.css("z-index",s.z);p();c.state=0;a(function(){e.removeClass("restoring");if(c.modal){e.addClass("modal")}},500);c.onRestored({$dlg:j})};j.close=function(){a(function(){e.addClass("closing");a(function(){e.removeClass("closing");e.remove();c.onClosed({$dlg:j})},300)},50)};j.dblclickTitleBar=function(){if(c.state===0){j.maximize()}else{j.restore()}};j.resetTitle=function(H){c.title=H};p();E.addEventListener("click",j.minimize);E.addEventListener("touchstart",j.minimize);o.addEventListener("click",j.restore);o.addEventListener("touchstart",j.restore);v.addEventListener("click",j.maximize);v.addEventListener("touchstart",j.maximize);d.addEventListener("click",j.close);d.addEventListener("touchstart",j.close);q.addEventListener("mousedown",m);q.addEventListener("touchstart",m);if(c.maximizable){f.addEventListener("dblclick",j.dblclickTitleBar)}var b=function(I,K){if(K.position){var H=K.position;I.move(H.x,H.y)}if(K.size){var J=K.size;I.resize(J.width,J.height)}if(K.modal){e.addClass("modal")}};b(j,g);setTimeout(function(){e.addClass("active");e.addClass("opening");j.selectWindow();setTimeout(function(){e.removeClass("opening");c.onOpen({$dlg:j})},400)},50)}}}]);